<!DOCTYPE html>
<html lang="en">
<head>
	<title>Cardographer Upload</title>
	<style>
        #warning {
            background: khaki;
            padding: 8px;
            margin: 8px;
            font-weight: bold;
	        opacity: 0;
	        border-radius: 5px;
        }

        .imageItem {
            padding: 8px 16px;
            cursor: pointer;
	        opacity: 1;
	        transition: opacity 0.5s;
        }

        .imageItem:hover {
			opacity: 0.5;
        }
	</style>
	<link rel="stylesheet" href="https://miro.com/app/static/styles.1.0.css"/>
</head>
<body>
<div class="miro-h2">Cardographer Upload</div>
<button id="upload">Upload</button>
<div id="warning" class="miro-p-large"></div>
<div id="missingTitles" class="miro-p-medium">
</div>
<script src="https://miro.com/app/static/sdk.1.1.js"></script>
<script defer>
	miro.onReady(() => {
		miro.addListener(miro.enums.event.SELECTION_UPDATED, getWidget)
		getWidget()
	})

	document.getElementById('upload').addEventListener('click', () => {
		upload()
	})

	const imageList = document.getElementById('missingTitles')
	const warning = document.getElementById('warning')

	async function getWidget() {
		const widgets = await miro.board.widgets.get()
		const untitled = widgets.filter((widget) => widget.type === "IMAGE" && widget.url === '' && widget.title === '')

		if (untitled.length > 0) {
			if(untitled.length === 1) {
				warning.innerText = "1 image needs a title before uploading:"
			} else {
				warning.innerText = untitled.length + " images need titles before uploading:"
			}
			warning.style.opacity = '1'

			imageList.innerHTML = ''
			untitled.forEach((image) => {
				const imageElement = document.createElement('div')
				imageElement.innerText = 'Image ' + image.id
				imageElement.classList.add('imageItem')
				imageElement.addEventListener('click', async () => {
					await miro.board.selection.selectWidgets(image.id)
					const rect = {
						x: image.bounds.left,
						y: image.bounds.top,
						width: image.bounds.right - image.bounds.left,
						height: image.bounds.bottom - image.bounds.top
					}
					await miro.board.viewport.set(rect)
				})

				imageList.append(imageElement)
			})

		} else {
			warning.style.opacity = '0'
			imageList.innerHTML = ''
		}
	}

	async function upload() {

	}
</script>
</body>
</html>